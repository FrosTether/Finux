#!/bin/bash

# ==========================================
# ðŸ§¬ FINUX SDK: LEVEL 0 SOURCE COMPILE
#    Target: Fivy (Kivy Fork)
#    Method: Cython -> C -> Assembly (Clang)
# ==========================================

SDK_ROOT="$HOME/finux-sdk"
SRC_DIR="$HOME/fivy_source"

echo ">> [INIT] Initializing FinuxSDK Toolchain..."

# 1. PREPARE THE BUILD ENVIRONMENT
# ------------------------------------------
# Wipe previous attempts to ensure a clean source build
rm -rf "$SDK_ROOT"
rm -rf "$SRC_DIR"
rm -rf "$HOME/finux"

echo ">> [DEPS] Installing Assembler & Headers..."
# These are the raw materials for the compiler
pkg update -y
pkg install -y \
    clang python make pkg-config git \
    xorgproto libx11 libxext libxrender \
    mesa libglvnd \
    sdl2 sdl2-image sdl2-ttf sdl2-mixer \
    libjpeg-turbo libpng freetype libxml2 libxslt

# 2. INITIALIZE FINUX SDK (Virtual Machine)
# ------------------------------------------
echo ">> [SDK] Creating Isolated Finux Environment..."
python3 -m venv "$SDK_ROOT"
source "$SDK_ROOT/bin/activate"

# 3. CONFIGURE COMPILER FLAGS (The "Assembly" Instructions)
# ------------------------------------------
echo ">> [LINK] Linking Hardware Drivers..."
export CC="clang"
export CXX="clang++"
# Force the compiler to use Termux's native graphics layer
export CFLAGS="-I$PREFIX/include -I$PREFIX/include/X11 -I$PREFIX/include/SDL2 -Wno-unused-command-line-argument"
export LDFLAGS="-L$PREFIX/lib -lm"
export USE_SDL2=1
export KIVY_SDL2_PATH="$PREFIX/include/SDL2"
export KIVY_IMAGE_SDL2=1

# 4. DOWNLOAD & PREPARE SOURCE CODE
# ------------------------------------------
echo ">> [SOURCE] Cloning Raw Engine Code..."
# We download the source instead of a pre-built wheel
pip install --upgrade pip setuptools
pip install "cython<3.0.0"

# This command downloads the Kivy source but doesn't install it yet
mkdir -p "$SRC_DIR"
cd "$SRC_DIR"
# We pull the specific stable tag to ensure the 963hz kernel is stable
git clone --depth 1 --branch 2.3.0 https://github.com/kivy/kivy.git .

# 5. EXECUTE CYTHON RECOMPILE (The Heavy Lift)
# ------------------------------------------
echo ">> [ASM] Transmuting Python to Assembly (C)..."
echo ">> WARNING: This step compiles 50+ modules. Wait 5-10 mins."

# This is the "Assembly Rebuild" step. 
# It translates .pyx -> .c -> .o (Object files) -> .so (Shared Objects)
python setup.py build_ext --inplace

echo ">> [INSTALL] Installing Fivy Engine into SDK..."
python setup.py install

# 6. DEPLOY FROSTCORE (963 Hz)
# ------------------------------------------
echo ">> [CORE] Injecting 963 Hz Logic..."
mkdir -p "$HOME/finux/core"
mkdir -p "$HOME/finux/fui"

# [A] 963 Hz KERNEL
cat <<EOF > "$HOME/finux/core/FrostNode.py"
import time, hashlib, struct
class FrostNode:
    def __init__(self):
        self.freq = 963.0
        self.cycle = 1.0 / self.freq
        self.id = "SDK_" + hashlib.sha256(str(time.time()).encode()).hexdigest()[:6]
        self.mining = False
    
    def mine(self):
        # Precise Frequency Sync
        time.sleep(self.cycle)
        # Generate Entropy
        entropy = struct.pack(">Q", int(time.time_ns()) & 0xFFFFFFFFFFFFFFFF)
        return time.time(), hashlib.sha256(entropy).hexdigest()
EOF

# [B] FINUX SDK UI
cat <<EOF > "$HOME/finux/fui/Virgo_Chat_UI.py"
import os, sys, threading
from kivy.config import Config
Config.set('graphics', 'maxfps', '30') 
os.environ['KIVY_GL_BACKEND'] = 'sdl2'
os.environ['KIVY_WINDOW'] = 'sdl2'

import kivy
from kivy.app import App
from kivy.uix.floatlayout import FloatLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.clock import Clock
from kivy.core.window import Window

sys.path.append(os.environ['HOME'] + "/finux/core")
from FrostNode import FrostNode

Window.clearcolor = (0, 0, 0, 1)

class FinuxSDK(FloatLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.node = FrostNode()
        self.hud = Label(
            text=f"[ ðŸ§¬ FINUX SDK: SOURCE BUILT ]\nEngine: Fivy (Cython Optimized)\nFreq: 963 Hz\nID: {self.node.id}",
            size_hint=(1, 0.4), pos_hint={'top': 1.0}, color=(0, 1, 0.5, 1)
        )
        self.add_widget(self.hud)
        self.input = TextInput(size_hint=(0.9, 0.08), pos_hint={'center_x': 0.5, 'y': 0.05})
        self.input.bind(on_text_validate=self.on_enter)
        self.add_widget(self.input)

    def on_enter(self, instance):
        if self.input.text == "/start":
            self.node.mining = True
            threading.Thread(target=self.loop, daemon=True).start()
            self.hud.text += "\n>> OSCILLATOR ACTIVE"
        self.input.text = ""

    def loop(self):
        while self.node.mining:
            res = self.node.mine()
            Clock.schedule_once(lambda dt: self.log(f"[963] HASH: {res[1][:10]}"))

    def log(self, t): self.hud.text += "\n" + t

class SDKApp(App):
    def build(self): return FinuxSDK()

if __name__ == "__main__": SDKApp().run()
EOF

# 7. SDK LAUNCHER
# ------------------------------------------
cat <<EOF > "$PREFIX/bin/finux"
#!/bin/bash
# Load the Finux SDK environment
source $SDK_ROOT/bin/activate
export USE_SDL2=1
export KIVY_GL_BACKEND=sdl2
echo "ðŸ§¬ Launching Finux SDK (Source Build)..."
python3 $HOME/finux/fui/Virgo_Chat_UI.py
EOF
chmod +x "$PREFIX/bin/finux"

echo "=========================================="
echo "âœ… FINUX SDK: REBUILT FROM SOURCE."
echo ">> Engine: Fivy (Compiled via Cython)"
echo ">> Mode: Assembly Optimization (Clang)"
echo ">> Launch: Type 'finux'"
echo "=========================================="
