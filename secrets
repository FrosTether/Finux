import secrets
import ecdsa
import binascii

# A simple in-memory store for active nonces (Use Redis in production)
active_challenges = {}

def generate_challenge(user_id):
    """
    Step 1: Create a secure, random challenge for the user.
    """
    # Generate a random 32-byte hex string
    nonce = secrets.token_hex(32)
    active_challenges[user_id] = nonce
    return nonce

def verify_biometric_response(user_id, public_key_hex, signature_hex):
    """
    Step 2: Verify that the user signed the specific nonce we issued.
    """
    if user_id not in active_challenges:
        return False
    
    expected_nonce = active_challenges.pop(user_id) # Consume nonce so it can't be reused
    
    try:
        vk = ecdsa.VerifyingKey.from_string(binascii.unhexlify(public_key_hex), curve=ecdsa.SECP256k1)
        # Verify that the signature matches the specific nonce issued for this user
        return vk.verify(binascii.unhexlify(signature_hex), expected_nonce.encode())
    except (ecdsa.BadSignatureError, Exception):
        return False
