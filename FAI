<!DOCTYPE html>
<html lang="en">
<head>
    <title>FAI | FrostBlocks ❄️</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta charset="UTF-8">
    <style>
        :root {
            --bg: #050505; --grid: #111; --cell: #1a1a1a;
            --frost-blue: #00f2ff; --frost-purple: #bc13fe;
            --voluntaryist-gold: #ffd700; --shadow: rgba(0, 242, 255, 0.2);
            --sb: env(safe-area-inset-bottom, 20px);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body {
            background: var(--bg); color: #fff; height: 100dvh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
            padding: 15px 15px var(--sb) 15px;
            background-image: linear-gradient(to bottom, #000 0%, #050505 100%);
        }
        /* Header & Stats */
        .fai-header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--frost-purple); padding-bottom: 5px; }
        .logo { font-weight: 900; letter-spacing: 2px; color: var(--frost-blue); text-shadow: 0 0 10px var(--frost-blue); }
        .score-box { text-align: right; }
        .score-box div { font-size: 10px; text-transform: uppercase; color: var(--frost-purple); }
        .score-box span { font-size: 20px; font-weight: bold; color: #fff; }

        /* The Grid */
        #grid {
            width: 100%; max-width: 380px; aspect-ratio: 1/1;
            background: var(--grid); border: 2px solid #333; border-radius: 8px;
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; padding: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,1); position: relative;
        }
        .cell { background: var(--cell); border-radius: 2px; transition: background 0.2s, box-shadow 0.2s; }
        .cell.filled { 
            background: linear-gradient(135deg, var(--frost-blue), var(--frost-purple)); 
            box-shadow: inset 0 0 5px rgba(255,255,255,0.4), 0 0 10px var(--frost-purple);
            border: none;
        }
        .cell.shadow { background: var(--shadow); border: 1px dashed var(--frost-blue); }

        /* Piece Tray */
        .tray {
            width: 100%; max-width: 400px; height: 120px;
            display: flex; justify-content: space-around; align-items: center;
            margin-top: 20px; background: rgba(255,255,255,0.03); border-radius: 15px;
            border: 1px solid #222;
        }
        .piece-slot { width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; }
        .drag-active { position: fixed; pointer-events: none; z-index: 100; transform: translateY(-120px) scale(1.1); filter: drop-shadow(0 0 15px var(--frost-blue)); }

        /* Controls */
        .btn-link {
            width: 90%; padding: 15px; margin-top: auto; border: none; border-radius: 30px;
            background: linear-gradient(90deg, var(--frost-purple), var(--frost-blue));
            color: #fff; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(188, 19, 254, 0.4);
        }
        .btn-link:active { transform: scale(0.98); opacity: 0.8; }
    </style>
</head>
<body onload="init()">

<div class="fai-header">
    <div class="logo">FAI // FROSTBLOCKS</div>
    <div class="score-box">
        <div>KOTH High Score</div>
        <span id="highScore">0</span>
    </div>
</div>

<div id="grid"></div>

<div class="tray" id="tray"></div>

<div style="margin-top: 15px; font-size: 12px; color: var(--frost-blue);">
    AI ORACLE: <span id="oracleStatus">IDLE</span> | VOLUNTARYIST NFT SYNCED
</div>

<button class="btn-link" onclick="toggleAI()">Engage FAI Neural Link</button>

<script>
    let board = Array(100).fill(0);
    let score = 0;
    let high = localStorage.getItem('fai_high') || 0;
    let dragging = null;
    let audioCtx = null;

    const shapes = [
        [[1,1,1]], [[1,1],[1,1]], [[1,1,1],[0,1,0]], [[1,1],[1,0],[1,0]], [[1]], [[1,1,1,1]], [[1,1,1],[1,0,0]]
    ];

    function init() {
        const g = document.getElementById('grid');
        g.innerHTML = '';
        for(let i=0; i<100; i++) {
            let c = document.createElement('div');
            c.className = 'cell'; c.id = 'cell-' + i;
            g.appendChild(c);
        }
        document.getElementById('highScore').innerText = high;
        refreshTray();
    }

    function toggleAI() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.getElementById('oracleStatus').innerText = "ACTIVE (40Hz)";
        playSfx(440, 'sine', 0.2);
    }

    function refreshTray() {
        const t = document.getElementById('tray');
        t.innerHTML = '';
        for(let i=0; i<3; i++) {
            let s = shapes[Math.floor(Math.random() * shapes.length)];
            let slot = document.createElement('div');
            slot.className = 'piece-slot';
            slot.appendChild(renderPiece(s, i));
            t.appendChild(slot);
        }
    }

    function renderPiece(shape, index) {
        const container = document.createElement('div');
        container.style.display = 'grid';
        container.style.gridTemplateColumns = `repeat(${shape[0].length}, 20px)`;
        container.style.gap = '2px';
        shape.forEach(row => row.forEach(val => {
            let c = document.createElement('div');
            c.style.width = '20px'; c.style.height = '20px';
            if(val) {
                c.className = 'cell filled';
                c.style.background = 'var(--frost-blue)';
            } else {
                c.style.opacity = '0';
            }
            container.appendChild(c);
        }));
        container.ontouchstart = (e) => startDrag(e, shape, index);
        return container;
    }

    function startDrag(e, shape, index) {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const touch = e.touches[0];
        dragging = { shape, index, el: renderPiece(shape, -1) };
        dragging.el.classList.add('drag-active');
        document.body.appendChild(dragging.el);
        moveDrag(touch);
    }

    document.ontouchmove = (e) => {
        if(!dragging) return;
        e.preventDefault();
        moveDrag(e.touches[0]);
    };

    function moveDrag(touch) {
        dragging.el.style.left = touch.clientX - (dragging.el.offsetWidth / 2) + 'px';
        dragging.el.style.top = touch.clientY + 'px';
        
        // Shadow Logic (AI Oracle assist)
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('shadow'));
        const target = document.elementFromPoint(touch.clientX, touch.clientY - 120);
        if(target && target.classList.contains('cell')) {
            const id = parseInt(target.id.split('-')[1]);
            if(canPlace(id, dragging.shape)) showShadow(id, dragging.shape);
        }
    }

    function canPlace(id, shape) {
        const r = Math.floor(id/10), c = id%10;
        for(let i=0; i<shape.length; i++) {
            for(let j=0; j<shape[0].length; j++) {
                if(shape[i][j]) {
                    let nr = r+i, nc = c+j;
                    if(nr >= 10 || nc >= 10 || board[nr*10 + nc]) return false;
                }
            }
        }
        return true;
    }

    function showShadow(id, shape) {
        const r = Math.floor(id/10), c = id%10;
        shape.forEach((row, i) => row.forEach((val, j) => {
            if(val) document.getElementById('cell-' + ((r+i)*10 + (c+j))).classList.add('shadow');
        }));
    }

    document.ontouchend = (e) => {
        if(!dragging) return;
        const touch = e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY - 120);
        
        if(target && target.classList.contains('cell')) {
            const id = parseInt(target.id.split('-')[1]);
            if(canPlace(id, dragging.shape)) {
                placePiece(id, dragging.shape);
                document.getElementById('tray').children[dragging.index].innerHTML = '';
                if([...document.getElementById('tray').querySelectorAll('.piece-slot')].every(s => s.innerHTML === '')) refreshTray();
            }
        }
        
        dragging.el.remove();
        dragging = null;
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('shadow'));
    };

    function placePiece(id, shape) {
        const r = Math.floor(id/10), c = id%10;
        shape.forEach((row, i) => row.forEach((val, j) => {
            if(val) {
                board[(r+i)*10 + (c+j)] = 1;
                document.getElementById('cell-' + ((r+i)*10 + (c+j))).classList.add('filled');
            }
        }));
        playSfx(600, 'triangle', 0.1);
        checkClears();
    }

    function checkClears() {
        let rows = [], cols = [];
        for(let i=0; i<10; i++) {
            let rF = true, cF = true;
            for(let j=0; j<10; j++) {
                if(!board[i*10 + j]) rF = false;
                if(!board[j*10 + i]) cF = false;
            }
            if(rF) rows.push(i);
            if(cF) cols.push(i);
        }

        rows.forEach(r => { for(let c=0; c<10; c++) board[r*10+c]=0; });
        cols.forEach(c => { for(let r=0; r<10; r++) board[r*10+c]=0; });

        if(rows.length > 0 || cols.length > 0) {
            score += (rows.length + cols.length) * 100;
            if(score > high) { high = score; localStorage.setItem('fai_high', high); }
            document.getElementById('highScore').innerText = high;
            playSfx(880, 'square', 0.3);
            setTimeout(initBoard, 200);
        }
    }

    function initBoard() {
        for(let i=0; i<100; i++) {
            const c = document.getElementById('cell-' + i);
            c.className = board[i] ? 'cell filled' : 'cell';
        }
    }

    function playSfx(f, type, d) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = f;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + d);
    }
</script>
</body>
</html>
